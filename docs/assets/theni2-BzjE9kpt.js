import"./pwa-BUDmkMds.js";import{c as E,L as j,T as x,U as C}from"./config-JvmG0hWQ.js";import{A as f}from"./audio_manager-CdHsL4ip.js";import{t as J}from"./theni_words-xXaqkVpm.js";const z={cachedModels:[],failedModels:new Set,apiKey:null,setApiKey(e){this.apiKey=e},async getPrioritizedModels(){if(this.cachedModels.length>0)return this.cachedModels;if(!this.apiKey)return console.log("[GeminiService] No API key, using default model"),[E.gemini.defaultModel];try{const e=await fetch(`${E.gemini.baseUrl}/models?key=${this.apiKey}`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const n=(await e.json()).models.filter(o=>o.name.includes("flash")&&!o.name.includes("preview")&&!o.name.includes("tts")&&!o.name.includes("image")&&o.supportedGenerationMethods?.includes("generateContent")).sort((o,s)=>{const i=o.name.includes("lite"),a=s.name.includes("lite");if(i!==a)return i?1:-1;const d=this.extractVersion(o.name);return this.extractVersion(s.name)-d});return n.length>0?(this.cachedModels=n.map(o=>o.name),console.log(`[GeminiService] Prioritized models: ${this.cachedModels.join(", ")}`),this.cachedModels):(console.warn("[GeminiService] No flash models found, using default"),[E.gemini.defaultModel])}catch(e){return console.error("[GeminiService] Error fetching models:",e),[E.gemini.defaultModel]}},extractVersion(e){const t=e.match(/gemini-(\d+\.?\d*)/);return t?parseFloat(t[1]):0},async generateContent(e){if(!this.apiKey)throw new Error("API key not set");const t=await this.getPrioritizedModels();for(const n of t)if(!this.failedModels.has(n))try{const s=await(await fetch(`${E.gemini.baseUrl}/${n}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:e}]}]})})).json();if(s.error){if(s.error.message?.includes("quota")||s.error.code===429){console.warn(`[GeminiService] Quota exceeded for model ${n}. Switching to fallback...`),this.failedModels.add(n);continue}throw new Error(s.error.message||"API Error")}const i=s.candidates?.[0]?.content?.parts?.[0]?.text;if(!i)throw new Error("No response text");return i}catch(o){if(o.message?.includes("429")||o.message?.toLowerCase().includes("quota")){console.warn(`[GeminiService] Network/Quota error for ${n}. Trying fallback...`),this.failedModels.add(n);continue}throw o}throw new Error("All available Gemini models have exhausted their quota. Please try again later.")}};class Q{constructor(t){this.systemPrompt=t}async callLLM(t){let n=0;const o=3;for(;n<o;)try{return await z.generateContent(t)}catch(s){if(n++,(s.message?.toLowerCase().includes("overloaded")||s.message?.includes("503")||s.message?.includes("429"))&&n<o){const a=Math.pow(2,n-1)*1e3;console.warn(`[BaseAgent] Model overloaded. Retrying in ${a}ms... (Attempt ${n})`),await new Promise(d=>setTimeout(d,a));continue}throw s}throw new Error("Max retries exceeded")}cleanJson(t){return t.replace(/```json\n?|\n?```/g,"").trim()}}class V extends Q{cache={};constructor(){super("You are a helpful Tamil language tutor. Your goal is to create simple, grammatically correct Tamil sentences using provided keywords.")}async generateSentence(t,n,o){const s=`${t}|${n}`;if(this.cache[s])return console.log("[SentenceAgent] Returning cached result"),this.cache[s];z.setApiKey(o);const i=`
            ${this.systemPrompt}
            
            Generate a simple Tamil sentence using these two words: "${t}" and "${n}".
            Provide the response in JSON format: { "tamil": "tamil sentence", "english": "english meaning" }
            IMPORTANT: Use the exact Tamil words provided if possible, or their correct declensions. Keep the sentence simple and suitable for learners.
        `;try{const a=await this.callLLM(i),d=this.cleanJson(a),m=JSON.parse(d);if(!m.tamil||!m.english)throw new Error("Invalid response structure from AI");return this.cache[s]=m,m}catch(a){throw console.error("[SentenceAgent] Error generating sentence:",a),a}}}let l=0,y=!1,I="all",g=[],w=[],L=[],r=[],S=!1,v={};const G={},W=new V;async function Y(){X(),ee(),K(),x.init(E.timerDurations.theni2),window.location.hash?F():p(!1),document.getElementById("aiBtn")?.addEventListener("click",P)}function X(){L=J.map((e,t)=>{const n=document.createElement("div");return n.className="slide",n.id=`slide - ${t} `,n.innerHTML=`
            <div class="category-badge">${e.category}</div>
            <div class="category-badge-ta">${e.category_ta}</div>
            <div class="difficulty-badge">${e.difficulty}</div>
            <div class="word-en">${e.word_en}</div>
            <div class="word-ta">${e.word_ta}</div>
        `,n}),r=[...L]}function A(){const e=document.getElementById("controlPanel");let t=!1;return e&&!e.classList.contains("collapsed")&&(e.classList.add("collapsed"),document.dispatchEvent(new CustomEvent("panelCollapsed")),t=!0),document.getElementById("categoryMenu")?.classList.remove("show"),t}function Z(e){e.stopPropagation(),document.getElementById("categoryMenu")?.classList.toggle("show")}function ee(){const e=new Map;L.forEach(n=>{const o=n.querySelector(".category-badge")?.textContent,s=n.querySelector(".category-badge-ta")?.textContent,i=`${o} - ${s}`;e.has(i)||e.set(i,!0)}),w=Array.from(e.keys()),g=[...w];const t=document.getElementById("categoryList");t&&(t.innerHTML="",w.forEach(n=>{const o=document.createElement("div");o.className="dropdown-item";const s=document.createElement("input");s.type="checkbox",s.checked=!0,s.id=`cat-${n}`;const i=document.createElement("span");i.innerText=n,o.appendChild(s),o.appendChild(i),o.addEventListener("click",a=>{a.stopPropagation(),T(n)}),s.addEventListener("click",a=>{a.stopPropagation(),T(n)}),o.setAttribute("tabindex","0"),o.setAttribute("role","checkbox"),o.setAttribute("aria-checked","true"),o.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),T(n))}),t.appendChild(o)})),D()}function T(e){const t=g.indexOf(e);t>-1?g.splice(t,1):g.push(e);const n=document.getElementById(`cat-${e}`);n&&(n.checked=g.includes(e)),D(),b()}function te(e){const t=document.getElementById("selectAllCats");e.target!==t&&(t.checked=!t.checked);const n=t.checked;n?g=[...w]:g=[],document.querySelectorAll("#categoryList input").forEach(o=>{o.checked=n}),D(),b()}function D(){const e=document.getElementById("selectedCatText"),t=document.getElementById("selectAllCats");!e||!t||(g.length===w.length?(e.textContent="All Categories",t.checked=!0):g.length===0?(e.textContent="None selected",t.checked=!1):(e.textContent=`${g.length} selected`,t.checked=!1))}function b(e=!0){r=L.filter(t=>{const n=t.querySelector(".difficulty-badge")?.textContent,o=t.querySelector(".category-badge")?.textContent,s=t.querySelector(".category-badge-ta")?.textContent,i=`${o} - ${s}`,a=I==="all"||n===I,d=g.includes(i);return a&&d}),S&&C.shuffleArray(r),v={},e&&(l=0),K(),p()}function h(e){I=e,document.querySelectorAll(".pill-button").forEach(n=>{n.classList.remove("active"),n.setAttribute("aria-pressed","false")});const t=document.getElementById(`filter${e==="all"?"All":e}`);t&&(t.classList.add("active"),t.setAttribute("aria-pressed","true")),b()}function N(){S=!0;const e=document.getElementById("btn-shuffle");e&&(e.classList.add("active"),e.setAttribute("aria-pressed","true")),b()}function U(){S=!1;const e=document.getElementById("btn-shuffle");e&&(e.classList.remove("active"),e.setAttribute("aria-pressed","false")),b()}function K(){const e=r.filter(i=>i.querySelector(".difficulty-badge")?.textContent==="D1").length,t=r.filter(i=>i.querySelector(".difficulty-badge")?.textContent==="D2").length,n=I==="all"?"All Difficulty":I,o=S?" (Shuffled)":"",s=document.getElementById("progressInfo");s&&(s.textContent=`${r.length===0?0:l+1}/${r.length} slides - Filter: ${n}${o} (Matches: D1=${e}, D2=${t})`)}function ne(e){localStorage.setItem("gemini_api_key",e);const t=document.getElementById("keyStatus");t&&(t.style.display="inline",setTimeout(()=>t.style.display="none",3e3))}function oe(){const e=localStorage.getItem("gemini_api_key");if(e){const t=document.getElementById("apiKeyInput");t&&(t.value=e)}}async function P(){const e=document.getElementById("aiBtn"),t=document.getElementById("aiResult"),n=document.getElementById("aiText"),o=document.getElementById("aiTextEn");x.pause();const s=document.getElementById("card1Ta")?.textContent,i=document.getElementById("card2Ta")?.textContent;if(!s||!i){alert("Cannot generate sentence without two words.");return}const a=localStorage.getItem("gemini_api_key");if(!a){t&&n&&o&&(n.textContent="üîë API Key Required",o.textContent="Please enter your Gemini API key in the settings panel above.",t.style.display="flex",t.classList.add("show"),t.style.borderLeftColor="#ff9800");const c=document.getElementById("controlPanel");c&&c.classList.contains("collapsed")&&c.classList.remove("collapsed");return}const d=a;if(!t||!n||!o)return;e&&(e.disabled=!0,e.innerHTML="<span>‚è≥</span> Generating..."),t.style.display="none",t.classList.remove("show"),n.textContent="",o.textContent="";try{const c=await W.generateSentence(s,i,d);m(c)}catch(c){const u=c instanceof Error?c.message:"Unknown error";console.error("AI Error:",c),n&&o&&t&&(n.textContent="‚ùå Error generating sentence",o.textContent=u,t.style.display="flex",t.classList.add("show"),t.style.borderLeftColor="#e53935")}finally{e&&(e.disabled=!1,e.innerHTML="<span>‚ú®</span> Generate Sentence")}function m(c){n.textContent=c.tamil,o.textContent=c.english,t.style.display="flex",t.style.borderLeftColor="#667eea",setTimeout(()=>t.classList.add("show"),10),y&&f.speak(c.tamil,"ta-IN")}}function O(){if(y=document.getElementById("audioToggle").checked,y){const t=r[l],n=v[l],o=n!==void 0?r[n]:null;if(t){const s=t.querySelector(".word-en")?.textContent,i=o?.querySelector(".word-en")?.textContent;s&&(f.speak(s,"en-US"),i&&setTimeout(()=>{y&&f.speak(i,"en-US")},1500))}}else f.synth&&f.synth.speaking&&f.synth.cancel()}function p(e=!0){const t=document.getElementById("aiResult"),n=document.getElementById("aiText"),o=document.getElementById("aiTextEn"),s=document.getElementById("aiBtn");if(t&&(t.style.display="none",t.classList.remove("show")),n&&(n.textContent=""),o&&(o.textContent=""),s&&(s.disabled=!1,s.innerHTML="<span>‚ú®</span> Generate Sentence with AI"),document.getElementById("card1")?.classList.remove("revealed"),document.getElementById("card2")?.classList.remove("revealed"),r.length<2){document.getElementById("card1En")&&(document.getElementById("card1En").textContent="Not enough words"),M(2,document.createElement("div"));return}const i=r[l];let a;if(v[l]!==void 0)a=v[l];else{do a=Math.floor(Math.random()*r.length);while(a===l);v[l]=a}const d=r[a],c=d.querySelector(".slide-image")?.dataset.word||d.querySelector(".word-en")?.textContent?.toLowerCase();if(c){const B=new Image;B.src=C.getImagePath(c)}if(M(1,i),M(2,d),y&&e){const B=i.querySelector(".word-en")?.textContent,R=d.querySelector(".word-en")?.textContent;B&&(f.speak(B,"en-US"),R&&setTimeout(()=>{y&&f.speak(R,"en-US")},1500))}document.getElementById("firstBtn").disabled=l===0,document.getElementById("prevBtn").disabled=l===0,document.getElementById("nextBtn").disabled=l===r.length-1,document.getElementById("lastBtn").disabled=l===r.length-1;const u=document.getElementById("counter");u&&(u.innerText=`${l+1} / ${r.length}`),C.updateProgress(l,r.length,"progressBar","counter"),K();const k=document.getElementById("showTimer");k&&k.checked&&x.restart()}function M(e,t){try{const n="card"+e,o=t.querySelector(".word-en")?.textContent||"",s=t.querySelector(".word-ta")?.textContent||"",i=t.querySelector(".category-badge")?.textContent||"",a=t.querySelector(".category-badge-ta")?.textContent||"",d=t.querySelector(".difficulty-badge")?.textContent||"",c=t.querySelector(".slide-image")?.dataset.word||o.toLowerCase();document.getElementById(n+"En")&&(document.getElementById(n+"En").textContent=o),document.getElementById(n+"Ta")&&(document.getElementById(n+"Ta").textContent=s),document.getElementById(n+"Cat")&&(document.getElementById(n+"Cat").textContent=i),document.getElementById(n+"CatTa")&&(document.getElementById(n+"CatTa").textContent=a),document.getElementById(n+"Diff")&&(document.getElementById(n+"Diff").textContent=d);const u=document.getElementById(n+"Img");if(u){if(G[c])u.src=G[c];else{const k=C.getImagePath(c);u.src=k,u.onerror=function(){u.onerror=null,u.src=`https://placehold.co/300x180?text=${encodeURIComponent(o)}`}}u.alt=o}}catch(n){console.error("Error in updateCard "+e+":",n)}}function H(){r.length>0&&(A(),l=0,p())}function _(){r.length>0&&(A(),l=r.length-1,p())}function q(e){const t=l+e;t>=0&&t<r.length&&(A(),l=t,p())}function $(){if(!r[l])return;const e=document.getElementById("card1"),t=document.getElementById("card2");if(!e||!t)return;e.classList.contains("revealed")&&t.classList.contains("revealed")?q(1):(e.classList.add("revealed"),t.classList.add("revealed"))}function F(){const e=window.location.hash.substring(1),t=`slide-${parseInt(e)-1}`,n=r.findIndex(o=>o.id===t);n!==-1?(l=n,p()):r.length>0&&(l>=r.length&&(l=0),p())}function se(){j.init({title:"‡Æ™‡Æø‡ÆØ‡Øã‡Æ∞‡Æø‡ÆØ‡Ææ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç‡Æ™‡Øç ‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø - ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç‡Æ§‡Øç ‡Æ§‡Øá‡Æ©‡Æø 2026 - Theni 2",contentHTML:`
            <div class="control-row">
                <span class="control-label">Categories:</span>
                <div class="category-dropdown">
                    <button class="dropdown-button" id="cat-dropdown-btn" title="Select word categories to display">
                        <span id="selectedCatText">All Categories</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="categoryMenu">
                        <div class="dropdown-item header" id="select-all-cat-row">
                            <input type="checkbox" id="selectAllCats" checked>
                            <span>Select All / None</span>
                        </div>
                        <div id="categoryList"></div>
                    </div>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Difficulty:</span>
                <div class="pill-group">
                    <button class="pill-button active" id="filterAll" title="Show all difficulty levels (A)" aria-pressed="true">All</button>
                    <button class="pill-button" id="filterD1" title="Show only Difficulty 1 words (1)" aria-pressed="false">D1 Only</button>
                    <button class="pill-button" id="filterD2" title="Show only Difficulty 2 words (2)" aria-pressed="false">D2 Only</button>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Sequence:</span>
                <div class="pill-group">
                    <button class="action-button" id="btn-shuffle" title="Randomize slide order (S)" aria-pressed="false"><span aria-hidden="true">üîÄ</span> Shuffle</button>
                    <button class="action-button" id="btn-reset-seq" title="Reset to original order (R)"><span aria-hidden="true">‚Ü©Ô∏è</span> Reset</button>
                </div>
                <div style="margin-left: auto; display: flex; gap: 15px;">
                    <label title="Show/hide countdown timer" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.85em;">
                        <input type="checkbox" id="showTimer" checked> ‚è±Ô∏è Timer (20s)
                    </label>
                    <label title="Enable/disable word pronunciation" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.85em;">
                        <input type="checkbox" id="audioToggle"> üîä Audio
                    </label>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Progress:</span>
                <span class="progress-info" id="progressInfo">Loading...</span>
                <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                    <label title="API key for AI sentence generation" style="font-size: 0.85em; display: flex; align-items: center; gap: 6px;">üîë Gemini AI API:</label>
                    <input type="password" id="apiKeyInput" placeholder="Enter API Key" title="Enter your Gemini API key for AI features"
                           style="padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); color: white; font-size: 0.85em; width: 140px;">
                    <style>#apiKeyInput::placeholder { color: rgba(255,255,255,0.7); font-style: italic; }</style>
                </div>
            </div>
        `,timerDisplay:"00:20",injectNavigation:!0}),document.getElementById("cat-dropdown-btn")?.addEventListener("click",Z),document.getElementById("select-all-cat-row")?.addEventListener("click",te),document.getElementById("filterAll")?.addEventListener("click",()=>h("all")),document.getElementById("filterD1")?.addEventListener("click",()=>h("D1")),document.getElementById("filterD2")?.addEventListener("click",()=>h("D2")),document.getElementById("btn-shuffle")?.addEventListener("click",N),document.getElementById("btn-reset-seq")?.addEventListener("click",U),document.getElementById("showTimer")?.addEventListener("change",x.toggleVisibility.bind(x)),document.getElementById("audioToggle")?.addEventListener("change",O),document.addEventListener("panelCollapsed",()=>{document.getElementById("audioToggle")?.checked&&!y&&(y=!0,O())}),document.getElementById("firstBtn")?.addEventListener("click",e=>{e.stopPropagation(),H()}),document.getElementById("prevBtn")?.addEventListener("click",e=>{e.stopPropagation(),q(-1)}),document.getElementById("nextBtn")?.addEventListener("click",e=>{e.stopPropagation(),$()}),document.getElementById("lastBtn")?.addEventListener("click",e=>{e.stopPropagation(),_()}),document.getElementById("apiKeyInput")?.addEventListener("change",e=>ne(e.target.value)),document.getElementById("aiBtn")?.addEventListener("click",P),document.addEventListener("click",e=>{const t=e.target;let n=!1;t.closest(".category-dropdown")||document.getElementById("categoryMenu")?.classList.remove("show"),t.closest(".control-panel")||(n=A()),!(t.closest("button")||t.closest("a")||t.closest("input")||t.closest(".control-panel")||t.closest(".category-dropdown")||t.closest(".modal")||t.closest(".keyboard-help-modal"))&&!n&&t.closest(".slide-container")&&$()}),document.addEventListener("keydown",e=>{e.key==="ArrowLeft"&&q(-1),(e.key==="ArrowRight"||e.key===" "||e.key==="Enter")&&$(),(e.key==="Home"||e.key==="[")&&H(),(e.key==="End"||e.key==="]")&&_(),e.key==="1"&&h("D1"),e.key==="2"&&h("D2"),(e.key==="a"||e.key==="A")&&h("all"),(e.key==="s"||e.key==="S")&&N(),(e.key==="r"||e.key==="R")&&U(),(e.key==="g"||e.key==="G")&&P()}),window.addEventListener("hashchange",F),oe(),Y()}document.addEventListener("DOMContentLoaded",se);
