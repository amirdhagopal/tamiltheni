import"./pwa-BUDmkMds.js";import{c as E,L as J,T as b,U as L}from"./config-JvmG0hWQ.js";import{A as f}from"./audio_manager-CdHsL4ip.js";import{t as V}from"./theni_words-xXaqkVpm.js";const H={cachedModels:[],failedModels:new Set,apiKey:null,setApiKey(e){this.apiKey=e},async getPrioritizedModels(){if(this.cachedModels.length>0)return this.cachedModels;if(!this.apiKey)return console.warn("[GeminiService] API key not set, using default model"),[E.gemini.defaultModel];try{const e=await fetch(`${E.gemini.baseUrl}/models?key=${this.apiKey}`);if(!e.ok)return console.warn("[GeminiService] Failed to fetch models, using default"),[E.gemini.defaultModel];const n=(await e.json()).models.filter(o=>(o.name.includes("gemini")||o.name.includes("gemma")||o.name.includes("learnlm"))&&!o.name.includes("tts")&&!o.name.includes("image")&&!o.name.includes("vision")&&!o.name.includes("embedding")&&o.supportedGenerationMethods?.includes("generateContent")).sort((o,s)=>{const a=o.name.toLowerCase(),i=s.name.toLowerCase(),d=a.includes("flash"),m=i.includes("flash");if(d!==m)return d?-1:1;const r=a.includes("lite"),u=i.includes("lite");if(r!==u)return r?1:-1;const p=!a.includes("preview")&&!a.includes("exp"),v=!i.includes("preview")&&!i.includes("exp");if(p!==v)return p?-1:1;const B=this.extractVersion(o.name);return this.extractVersion(s.name)-B});return n.length>0?(this.cachedModels=n.map(o=>o.name),console.log(`[GeminiService] Full prioritized rotation: ${this.cachedModels.join(", ")}`),this.cachedModels):(console.warn("[GeminiService] No flash models found, using default"),[E.gemini.defaultModel])}catch(e){return console.error("[GeminiService] Error fetching models:",e),[E.gemini.defaultModel]}},extractVersion(e){const t=e.match(/[a-z]-(\d+\.?\d*)/i)||e.match(/-(\d+\.?\d*)/);return t?parseFloat(t[1]):0},async generateContent(e){if(!this.apiKey)throw new Error("API key not set");const t=await this.getPrioritizedModels();for(const n of t)if(!this.failedModels.has(n))try{console.log(`[GeminiService] Attempting generation with model: ${n}`);const o=await fetch(`https://generativelanguage.googleapis.com/v1beta/${n}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:e}]}]})});if(o.status===429){console.warn(`[GeminiService] Quota exceeded for model ${n}. Switching to fallback...`),this.failedModels.add(n);continue}if(!o.ok){const i=await o.json().catch(()=>({}));throw new Error(`API error (${o.status}): ${i.error?.message||o.statusText}`)}const a=(await o.json()).candidates?.[0]?.content?.parts?.[0]?.text;if(!a)throw new Error("Empty response from Gemini");return console.log(`[GeminiService] Successfully generated content using: ${n}`),a}catch(o){if(o.message?.includes("429")||o.message?.toLowerCase().includes("quota"))continue;throw o}throw new Error("All available Gemini models have exhausted their quota. Please try again later.")}};class W{constructor(t){this.systemPrompt=t}async callLLM(t){let n=0;const o=3;for(;n<o;)try{return await H.generateContent(t)}catch(s){if(n++,(s.message?.toLowerCase().includes("overloaded")||s.message?.includes("503")||s.message?.includes("429"))&&n<o){const i=Math.pow(2,n-1)*1e3;console.warn(`[BaseAgent] Model overloaded. Retrying in ${i}ms... (Attempt ${n})`),await new Promise(d=>setTimeout(d,i));continue}throw s}throw new Error("Max retries exceeded")}cleanJson(t){return t.replace(/```json\n?|\n?```/g,"").trim()}}class Y extends W{cache={};constructor(){super("You are a helpful Tamil language tutor. Your goal is to create simple, grammatically correct Tamil sentences using provided keywords.")}async generateSentence(t,n,o){const s=`${t}|${n}`;if(this.cache[s])return console.log("[SentenceAgent] Returning cached result"),this.cache[s];H.setApiKey(o);const a=`
            ${this.systemPrompt}
            
            Generate a simple Tamil sentence using these two words: "${t}" and "${n}".
            Provide the response in JSON format: { "tamil": "tamil sentence", "english": "english meaning" }
            IMPORTANT: Provide the COMPLETE sentence. Do NOT truncate or use ellipses (...). Use the exact Tamil words provided if possible, or their correct declensions. Keep the sentence simple and suitable for learners.
        `;try{const i=await this.callLLM(a),d=this.cleanJson(i),m=JSON.parse(d);if(!m.tamil||!m.english)throw new Error("Invalid response structure from AI");return this.cache[s]=m,m}catch(i){throw console.error("[SentenceAgent] Error generating sentence:",i),i}}}let c=0,y=!1,k="all",g=[],I=[],S=[],l=[],A=!1,x={};const R={},Q=new Y;async function X(){Z(),te(),G(),b.init(E.timerDurations.theni2),window.location.hash?j():h(!1),document.getElementById("aiBtn")?.addEventListener("click",D)}function Z(){S=V.map((e,t)=>{const n=document.createElement("div");return n.className="slide",n.id=`slide - ${t} `,n.innerHTML=`
            <div class="category-badge">${e.category}</div>
            <div class="category-badge-ta">${e.category_ta}</div>
            <div class="difficulty-badge">${e.difficulty}</div>
            <div class="word-en">${e.word_en}</div>
            <div class="word-ta">${e.word_ta}</div>
        `,n}),l=[...S]}function T(){const e=document.getElementById("controlPanel");let t=!1;return e&&!e.classList.contains("collapsed")&&(e.classList.add("collapsed"),document.dispatchEvent(new CustomEvent("panelCollapsed")),t=!0),document.getElementById("categoryMenu")?.classList.remove("show"),t}function ee(e){e.stopPropagation(),document.getElementById("categoryMenu")?.classList.toggle("show")}function te(){const e=new Map;S.forEach(n=>{const o=n.querySelector(".category-badge")?.textContent,s=n.querySelector(".category-badge-ta")?.textContent,a=`${o} - ${s}`;e.has(a)||e.set(a,!0)}),I=Array.from(e.keys()),g=[...I];const t=document.getElementById("categoryList");t&&(t.innerHTML="",I.forEach(n=>{const o=document.createElement("div");o.className="dropdown-item";const s=document.createElement("input");s.type="checkbox",s.checked=!0,s.id=`cat-${n}`;const a=document.createElement("span");a.innerText=n,o.appendChild(s),o.appendChild(a),o.addEventListener("click",i=>{i.stopPropagation(),M(n)}),s.addEventListener("click",i=>{i.stopPropagation(),M(n)}),o.setAttribute("tabindex","0"),o.setAttribute("role","checkbox"),o.setAttribute("aria-checked","true"),o.addEventListener("keydown",i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),M(n))}),t.appendChild(o)})),K()}function M(e){const t=g.indexOf(e);t>-1?g.splice(t,1):g.push(e);const n=document.getElementById(`cat-${e}`);n&&(n.checked=g.includes(e)),K(),C()}function ne(e){const t=document.getElementById("selectAllCats");e.target!==t&&(t.checked=!t.checked);const n=t.checked;n?g=[...I]:g=[],document.querySelectorAll("#categoryList input").forEach(o=>{o.checked=n}),K(),C()}function K(){const e=document.getElementById("selectedCatText"),t=document.getElementById("selectAllCats");!e||!t||(g.length===I.length?(e.textContent="All Categories",t.checked=!0):g.length===0?(e.textContent="None selected",t.checked=!1):(e.textContent=`${g.length} selected`,t.checked=!1))}function C(e=!0){l=S.filter(t=>{const n=t.querySelector(".difficulty-badge")?.textContent,o=t.querySelector(".category-badge")?.textContent,s=t.querySelector(".category-badge-ta")?.textContent,a=`${o} - ${s}`,i=k==="all"||n===k,d=g.includes(a);return i&&d}),A&&L.shuffleArray(l),x={},e&&(c=0),G(),h()}function w(e){k=e,document.querySelectorAll(".pill-button").forEach(n=>{n.classList.remove("active"),n.setAttribute("aria-pressed","false")});const t=document.getElementById(`filter${e==="all"?"All":e}`);t&&(t.classList.add("active"),t.setAttribute("aria-pressed","true")),C()}function N(){A=!0;const e=document.getElementById("btn-shuffle");e&&(e.classList.add("active"),e.setAttribute("aria-pressed","true")),C()}function O(){A=!1;const e=document.getElementById("btn-shuffle");e&&(e.classList.remove("active"),e.setAttribute("aria-pressed","false")),C()}function G(){const e=l.filter(a=>a.querySelector(".difficulty-badge")?.textContent==="D1").length,t=l.filter(a=>a.querySelector(".difficulty-badge")?.textContent==="D2").length,n=k==="all"?"All Difficulty":k,o=A?" (Shuffled)":"",s=document.getElementById("progressInfo");s&&(s.textContent=`${l.length===0?0:c+1}/${l.length} slides - Filter: ${n}${o} (Matches: D1=${e}, D2=${t})`)}function oe(e){localStorage.setItem("gemini_api_key",e);const t=document.getElementById("keyStatus");t&&(t.style.display="inline",setTimeout(()=>t.style.display="none",3e3))}function se(){const e=localStorage.getItem("gemini_api_key");if(e){const t=document.getElementById("apiKeyInput");t&&(t.value=e)}}async function D(){const e=document.getElementById("aiBtn"),t=document.getElementById("aiResult"),n=document.getElementById("aiText"),o=document.getElementById("aiTextEn");b.pause();const s=document.getElementById("card1Ta")?.textContent,a=document.getElementById("card2Ta")?.textContent;if(!s||!a){alert("Cannot generate sentence without two words.");return}const i=localStorage.getItem("gemini_api_key");if(!i){t&&n&&o&&(n.textContent="üîë API Key Required",o.textContent="Please enter your Gemini API key in the settings panel above.",t.style.display="flex",t.classList.add("show"),t.style.borderLeftColor="#ff9800");const r=document.getElementById("controlPanel");r&&r.classList.contains("collapsed")&&r.classList.remove("collapsed");return}const d=i;if(!t||!n||!o)return;e&&(e.disabled=!0,e.innerHTML="<span>‚è≥</span> Generating..."),t.style.display="none",t.classList.remove("show"),n.textContent="",o.textContent="";try{const r=await Q.generateSentence(s,a,d);m(r)}catch(r){const u=r instanceof Error?r.message:"Unknown error";console.error("AI Error:",r),n&&o&&t&&(n.textContent="‚ùå Error generating sentence",o.textContent=u,t.style.display="flex",t.classList.add("show"),t.style.borderLeftColor="#e53935")}finally{e&&(e.disabled=!1,e.innerHTML="<span>‚ú®</span> Generate Sentence")}function m(r){console.log("[Theni2] AI Response:",r),n.textContent=r.tamil,o.textContent=r.english,t.style.display="flex",t.style.borderLeftColor="#667eea",setTimeout(()=>t.classList.add("show"),10),y&&f.speak(r.tamil,"ta-IN")}}function F(){if(y=document.getElementById("audioToggle").checked,y){const t=l[c],n=x[c],o=n!==void 0?l[n]:null;if(t){const s=t.querySelector(".word-en")?.textContent,a=o?.querySelector(".word-en")?.textContent;s&&(f.speak(s,"en-US"),a&&setTimeout(()=>{y&&f.speak(a,"en-US")},1500))}}else f.synth&&f.synth.speaking&&f.synth.cancel()}function h(e=!0){const t=document.getElementById("aiResult"),n=document.getElementById("aiText"),o=document.getElementById("aiTextEn"),s=document.getElementById("aiBtn");if(t&&(t.style.display="none",t.classList.remove("show")),n&&(n.textContent=""),o&&(o.textContent=""),s&&(s.disabled=!1,s.innerHTML="<span>‚ú®</span> Generate Sentence with AI"),document.getElementById("card1")?.classList.remove("revealed"),document.getElementById("card2")?.classList.remove("revealed"),l.length<2){document.getElementById("card1En")&&(document.getElementById("card1En").textContent="Not enough words"),$(2,document.createElement("div"));return}const a=l[c];let i;if(x[c]!==void 0)i=x[c];else{do i=Math.floor(Math.random()*l.length);while(i===c);x[c]=i}const d=l[i],r=d.querySelector(".slide-image")?.dataset.word||d.querySelector(".word-en")?.textContent?.toLowerCase();if(r){const v=new Image;v.src=L.getImagePath(r)}if($(1,a),$(2,d),y&&e){const v=a.querySelector(".word-en")?.textContent,B=d.querySelector(".word-en")?.textContent;v&&(f.speak(v,"en-US"),B&&setTimeout(()=>{y&&f.speak(B,"en-US")},1500))}document.getElementById("firstBtn").disabled=c===0,document.getElementById("prevBtn").disabled=c===0,document.getElementById("nextBtn").disabled=c===l.length-1,document.getElementById("lastBtn").disabled=c===l.length-1;const u=document.getElementById("counter");u&&(u.innerText=`${c+1} / ${l.length}`),L.updateProgress(c,l.length,"progressBar","counter"),G();const p=document.getElementById("showTimer");p&&p.checked&&b.restart()}function $(e,t){try{const n="card"+e,o=t.querySelector(".word-en")?.textContent||"",s=t.querySelector(".word-ta")?.textContent||"",a=t.querySelector(".category-badge")?.textContent||"",i=t.querySelector(".category-badge-ta")?.textContent||"",d=t.querySelector(".difficulty-badge")?.textContent||"",r=t.querySelector(".slide-image")?.dataset.word||o.toLowerCase();document.getElementById(n+"En")&&(document.getElementById(n+"En").textContent=o),document.getElementById(n+"Ta")&&(document.getElementById(n+"Ta").textContent=s),document.getElementById(n+"Cat")&&(document.getElementById(n+"Cat").textContent=a),document.getElementById(n+"CatTa")&&(document.getElementById(n+"CatTa").textContent=i),document.getElementById(n+"Diff")&&(document.getElementById(n+"Diff").textContent=d);const u=document.getElementById(n+"Img");if(u){if(R[r])u.src=R[r];else{const p=L.getImagePath(r);u.src=p,u.onerror=function(){u.onerror=null,u.src=`https://placehold.co/300x180?text=${encodeURIComponent(o)}`}}u.alt=o}}catch(n){console.error("Error in updateCard "+e+":",n)}}function U(){l.length>0&&(T(),c=0,h())}function z(){l.length>0&&(T(),c=l.length-1,h())}function q(e){const t=c+e;t>=0&&t<l.length&&(T(),c=t,h())}let _=0;function P(){const e=Date.now();if(e-_<300||(_=e,!l[c]))return;const t=document.getElementById("card1"),n=document.getElementById("card2");if(!t||!n)return;t.classList.contains("revealed")&&n.classList.contains("revealed")?q(1):(t.classList.add("revealed"),n.classList.add("revealed"))}function j(){const e=window.location.hash.substring(1),t=`slide-${parseInt(e)-1}`,n=l.findIndex(o=>o.id===t);n!==-1?(c=n,h()):l.length>0&&(c>=l.length&&(c=0),h())}function ie(){J.init({title:"‡Æ™‡Æø‡ÆØ‡Øã‡Æ∞‡Æø‡ÆØ‡Ææ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç‡Æ™‡Øç ‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø - ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç‡Æ§‡Øç ‡Æ§‡Øá‡Æ©‡Æø 2026 - Theni 2",contentHTML:`
            <div class="control-row">
                <span class="control-label">Categories:</span>
                <div class="category-dropdown">
                    <button class="dropdown-button" id="cat-dropdown-btn" title="Select word categories to display">
                        <span id="selectedCatText">All Categories</span>
                        <span>‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="categoryMenu">
                        <div class="dropdown-item header" id="select-all-cat-row">
                            <input type="checkbox" id="selectAllCats" checked>
                            <span>Select All / None</span>
                        </div>
                        <div id="categoryList"></div>
                    </div>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Difficulty:</span>
                <div class="pill-group">
                    <button class="pill-button active" id="filterAll" title="Show all difficulty levels (A)" aria-pressed="true">All</button>
                    <button class="pill-button" id="filterD1" title="Show only Difficulty 1 words (1)" aria-pressed="false">D1 Only</button>
                    <button class="pill-button" id="filterD2" title="Show only Difficulty 2 words (2)" aria-pressed="false">D2 Only</button>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Sequence:</span>
                <div class="pill-group">
                    <button class="action-button" id="btn-shuffle" title="Randomize slide order (S)" aria-pressed="false"><span aria-hidden="true">üîÄ</span> Shuffle</button>
                    <button class="action-button" id="btn-reset-seq" title="Reset to original order (R)"><span aria-hidden="true">‚Ü©Ô∏è</span> Reset</button>
                </div>
                <div style="margin-left: auto; display: flex; gap: 15px;">
                    <label title="Show/hide countdown timer" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.85em;">
                        <input type="checkbox" id="showTimer" checked> ‚è±Ô∏è Timer (20s)
                    </label>
                    <label title="Enable/disable word pronunciation" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.85em;">
                        <input type="checkbox" id="audioToggle"> üîä Audio
                    </label>
                </div>
            </div>
            <div class="control-row">
                <span class="control-label">Progress:</span>
                <span class="progress-info" id="progressInfo">Loading...</span>
                <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                    <label title="API key for AI sentence generation" style="font-size: 0.85em; display: flex; align-items: center; gap: 6px;">üîë Gemini AI API:</label>
                    <input type="password" id="apiKeyInput" placeholder="Enter API Key" title="Enter your Gemini API key for AI features"
                           style="padding: 4px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); color: white; font-size: 0.85em; width: 140px;">
                    <style>#apiKeyInput::placeholder { color: rgba(255,255,255,0.7); font-style: italic; }</style>
                </div>
            </div>
        `,timerDisplay:"00:20",injectNavigation:!0}),document.getElementById("cat-dropdown-btn")?.addEventListener("click",ee),document.getElementById("select-all-cat-row")?.addEventListener("click",ne),document.getElementById("filterAll")?.addEventListener("click",()=>w("all")),document.getElementById("filterD1")?.addEventListener("click",()=>w("D1")),document.getElementById("filterD2")?.addEventListener("click",()=>w("D2")),document.getElementById("btn-shuffle")?.addEventListener("click",N),document.getElementById("btn-reset-seq")?.addEventListener("click",O),document.getElementById("showTimer")?.addEventListener("change",b.toggleVisibility.bind(b)),document.getElementById("audioToggle")?.addEventListener("change",F),document.addEventListener("panelCollapsed",()=>{document.getElementById("audioToggle")?.checked&&!y&&(y=!0,F())}),document.getElementById("firstBtn")?.addEventListener("click",e=>{e.stopPropagation(),U()}),document.getElementById("prevBtn")?.addEventListener("click",e=>{e.stopPropagation(),q(-1)}),document.getElementById("nextBtn")?.addEventListener("click",e=>{e.stopPropagation(),P()}),document.getElementById("lastBtn")?.addEventListener("click",e=>{e.stopPropagation(),z()}),document.getElementById("apiKeyInput")?.addEventListener("change",e=>oe(e.target.value)),document.getElementById("aiBtn")?.addEventListener("click",D),document.addEventListener("click",e=>{const t=e.target;let n=!1;t.closest(".category-dropdown")||document.getElementById("categoryMenu")?.classList.remove("show"),t.closest(".control-panel")||(n=T()),!(t.closest("button")||t.closest("a")||t.closest("input")||t.closest(".control-panel")||t.closest(".category-dropdown")||t.closest(".modal")||t.closest(".keyboard-help-modal"))&&!n&&t.closest(".slide-container")&&P()}),document.addEventListener("keydown",e=>{e.key==="ArrowLeft"&&q(-1),(e.key==="ArrowRight"||e.key===" "||e.key==="Enter")&&(e.key===" "&&e.preventDefault(),P()),(e.key==="Home"||e.key==="[")&&U(),(e.key==="End"||e.key==="]")&&z(),e.key==="1"&&w("D1"),e.key==="2"&&w("D2"),(e.key==="a"||e.key==="A")&&w("all"),(e.key==="s"||e.key==="S")&&N(),(e.key==="r"||e.key==="R")&&O(),(e.key==="g"||e.key==="G")&&D()}),window.addEventListener("hashchange",j),se(),X()}document.addEventListener("DOMContentLoaded",ie);
